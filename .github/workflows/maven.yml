name: 🧪 Run KestrelPro Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  kestrelpro-ci:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: ☕ Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 📦 Install Maven
        run: mvn install -DskipTests

      - name: 🧪 Build & Run Tests
        run: mvn clean test
        continue-on-error: true

      - name: 🌐 Set up Node.js
        if: always()
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 📦 Install Puppeteer
        if: always()
        run: |
          npm install puppeteer

      - name: 📄 Generate Extent PDF Reports (Tests + Dashboard)
        if: always()
        run: |
          node <<'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');

          (async () => {
            const browser = await puppeteer.launch({
              headless: true,
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });
            const page = await browser.newPage();

            await page.goto('file://' + process.cwd() + '/test-output/ExtentReports.html', {waitUntil: 'networkidle0'});

            // Expand all skipped/failure/test cases (modify selector if needed)
            try {
              await page.evaluate(() => {
                document.querySelectorAll('.node-toggle').forEach(el => el.click());
              });
            } catch (e) {
              console.log('❗ Could not expand test nodes. Continuing...');
            }

            await page.pdf({ path: 'test-output/KestrelReport.pdf', format: 'A4' });

            await browser.close();
          })();
          EOF

      - name: 📤 Upload Final PDF Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: KestrelReport
          path: test-output/KestrelReport.pdf
